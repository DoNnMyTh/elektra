.modal-body
  %ul.nav.nav-tabs
    %li.active{role: "presentation"}= link_to 'Process', '#process', aria: {controls:"process"}, role: "tab", data: {toggle:"tab"}
    %li{role: "presentation"}
      = link_to '#payload', aria: {controls:"payload"}, role: "tab", data: {toggle:"tab"} do
        Payload
    %li{role: "presentation"}
      = link_to '#process_steps', aria: {controls:"process_steps"}, role: "tab", data: {toggle:"tab"} do
        Process Steps
        %span.badge= @inquiry.process_steps.length
  .tab-content
    .tab-pane.active{role:"tabpanel", id:"process"}
      = simple_form_for @inquiry, url: plugin('inquiry').inquiry_path(domain_id: @scoped_domain_fid, project_id: @scoped_project_fid, id:@inquiry.id), method: :put, remote: request.xhr?, html: {data: {modal: true} } do |f|

        %div{class: modal? ? 'modal-body' : ''}
          - unless @inquiry.errors["message"].blank?
            %p.alert.alert-error= @inquiry.errors.full_messages.to_sentence

          %fieldset
            %fieldset
            = f.input :kind, label: "Kind", disabled: true
            = f.input :requester_full_name, label: "Requested by", disabled: true
            = f.input :requester_email, label: "Requester email", disabled: true
            = f.input :description, label: "Reason for Request", as: :text, disabled: true
            = f.input :aasm_state, { label: "Set new State",
              as: :select,
              :include_blank => false,
              collection: @inquiry.actions_allowed }
            = f.input :process_step_description, label: "Reason for State Change", as: :text, required: true

        %div.buttons{class: modal? ? 'modal-footer' : ''}
          - if modal?
            %button.btn.btn-default{type:"button", data: {dismiss:"modal"}, aria: {label: "Cancel"}} Cancel
          - else
            = link_to "Cancel", inquiries_url(), class: 'btn btn-default'
          %button{type: "submit", class: 'btn btn-primary', data: { disable_with: 'Please wait...'}} Save

    .tab-pane{role:"tabpanel", id:"payload"}
      %table.table.datatable
      %tbody
        %tr
          %td
            %pre= JSON.pretty_generate(@inquiry.payload) rescue "Error during rendering of JSON payload!"

    .tab-pane{role:"tabpanel", id:"process_steps"}
      %table.table.datatable
        %tbody
          %tr
            %th Processor
            %th From state
            %th To State
            %th Date
            %th Reason
          - @inquiry.process_steps.each do |step|
            %tr
              %td= step.processor.try(:full_name)
              %td= step.from_state
              %td= step.to_state
              %td= step.created_at.getlocal.strftime("%F %T")
              %td{:width => "300"}= step.description
