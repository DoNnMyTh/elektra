.row
  .col-md-2.quota-label
    .text-muted
      - if overview
        = link_to t("resource_management.#{data[:name]}"), plugin('resource_management').send("resources_area_path", data.attributes[:area])
      - else
        = t("resource_management.#{data[:name]}")
      - if overview
        .small
          .small= t(service)

  .col-md-7
    - display_unit              = data[:domain_quota].attributes[:display_unit] || 1
    - active_project_quota     = data[:active_project_quota]
    - current_project_quota_sum = (data[:current_project_quota_sum]  / display_unit).to_i
    -# increment because we lost -1 in the controller quota summary
    - current_project_quota_sum = current_project_quota_sum.next if not active_project_quota
    - approved_quota_for_domain = (data[:domain_quota].approved_quota / display_unit).to_i
    - usage_percent             = ((data[:current_project_quota_sum].to_f / data[:domain_quota].approved_quota.to_f) *100).to_i
    - approved_percent          = ((data[:domain_quota].approved_quota.to_f / data[:domain_quota].approved_quota.to_f) *100).to_i
    - usage_level               = data[:current_project_quota_sum].to_f / [data[:current_project_quota_sum], data[:domain_quota].approved_quota].max.to_f
    - if active_project_quota and approved_quota_for_domain >= 0 
      - overcommit = usage_percent-100
      - if overcommit > 0
        - usage_percent = 100-overcommit
      .quota
        - if approved_quota_for_domain < current_project_quota_sum
          .quota-approved{:style => "right:#{overcommit}%"} 
            %span.text-nowrap
              approved quota for domain: #{approved_quota_for_domain}

        .quota-current
          - if approved_quota_for_domain < current_project_quota_sum
            %span.text-nowrap #{current_project_quota_sum}
          - else 
            %span.text-nowrap #{approved_quota_for_domain}
        .progress
          - if usage_level >= @usage_stage[:danger]
            .progress-bar.progress-bar-quota.progress-bar-danger{:style => "width:#{usage_percent}%"}= current_project_quota_sum
          - elsif usage_level >= @usage_stage[:warning]
            .progress-bar.progress-bar-quota.progress-bar-warning{:style => "width:#{usage_percent}%"}= current_project_quota_sum
          - else
            .progress-bar.progress-bar-quota{:style => "width:#{usage_percent}%"}= current_project_quota_sum
          -if approved_quota_for_domain < current_project_quota_sum
            .progress-bar.progress-bar-quota.quota-overcommit-danger{:style => "width:#{overcommit}%"}
    - else
      -# Handle unlimted quota  
      .quota
        - if not active_project_quota and approved_quota_for_domain > 0
          .quota-current-danger
            %span.text-nowrap one or more projects are currently unlimited but approved quota for this domain is #{approved_quota_for_domain}
          .progress
            .progress-bar.progress-bar-quota.quota-overcommit-danger{:style => "width:100%"}
              quota summary #{current_project_quota_sum}
        - else  
          .quota-current
            %span.text-nowrap unlimited
          .progress
            .progress-bar.progress-bar-quota.quota-overcommit{:style => "width:100%"}

  .col-md-1.quota-request-more
    = link_to 'Details', '#', class: 'btn btn-primary btn-sm', title: 'open related service'
  .col-md-1.quota-request-more
    - if data[:current_project_quota_sum] > 0 and data[:domain_quota].approved_quota >= 0
      = link_to 'Request more',plugin('resource_management').resources_request_path(:service => service, :resource => data[:name] ), data: {modal: true}, class: 'btn btn-primary btn-sm'
    - else
      = link_to 'Request more','#', class: 'btn btn-primary btn-sm disabled'
